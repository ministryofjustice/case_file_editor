#!/usr/bin/env ruby
APP_PATH = File.expand_path('../../config/application',  __FILE__)
require_relative '../config/boot'
require APP_PATH
Rails.application.require_environment!

models = Dir['app/models/*.rb'].
  map { |f|
    snake_case = File.basename(f, '.rb')
    require snake_case

    klass =
      ActiveSupport::Inflector.constantize(
        ActiveSupport::Inflector.camelize(snake_case))
  }.
  select { |c| c.is_a?(Class) }.
  map { |klass| [klass, FieldInspector.new.fields(klass)] }.
  to_h

models.sort_by { |k, _| k.to_s }.each do |klass, fields|
  mapper_class_name = "#{klass}Mapper"
  snake_case = ActiveSupport::Inflector.underscore(mapper_class_name)
  path = "app/mappers/#{snake_case}.rb"
  puts path

  File.open(path, 'w') do |file|
    file.puts "class #{mapper_class_name} < Yaks::Mapper"
    if fields.any?(&:basic?)
      file.puts '  attributes \\'
      file.puts fields.select(&:basic?).map { |f| "    :#{f.name}" }.join(",\n")
    end
    fields.reject(&:basic?).each do |f|
      if f.array?
        file.puts "  has_many :#{f.name}"
      else
        file.puts "  has_one :#{f.name}"
      end
    end
    file.puts "end"
  end
end
